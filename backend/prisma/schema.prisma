generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  CREATOR
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String
  role         Role      @default(USER)
  name         String?
  avatar_url   String?
  createdAt    DateTime  @default(now())
  reviews      Review[]
  submissions  Submission[]
}

model Tool {
  id           Int        @id @default(autoincrement())
  name         String
  slug         String     @unique
  
  // Basic Info
  short_description String?  @db.Text
  tagline      String?
  
  // Detailed Information
  description  String     @db.Text
  key_features String[]
  pros         String[]
  cons         String[]
  ideal_for    String?
  
  // Pricing & Access
  pricing_type String?    // Free, Freemium, Paid, One-time, Open Source
  pricing      String?
  price_range  String?
  free_trial   Boolean    @default(false)
  open_source  Boolean    @default(false)
  repo_url     String?
  
  // Technical Info
  website      String
  platforms    String[]
  models_used  String[]
  primary_model String?
  integrations String[]
  api_available Boolean   @default(false)
  api_docs_url String?
  
  // Branding
  logo_url     String?
  brand_color_primary   String?
  brand_color_secondary String?
  screenshots  String[]
  
  // Metadata
  release_year Int?
  company_name String?
  company_size String?
  
  // SEO
  seo_title    String?
  seo_meta_description String?
  social_share_image String?
  
  // Engagement
  use_cases    String[]
  allow_reviews Boolean   @default(true)
  
  // Admin Status
  verified     Boolean    @default(false)
  featured     Boolean    @default(false)
  trending     Boolean    @default(false)
  editors_choice Boolean  @default(false)
  still_active Boolean    @default(true)
  
  // Analytics
  click_count  Int        @default(0)
  view_count   Int        @default(0)
  
  // Auto-Import Tracking
  source       String?    // huggingface, openrouter, rapidapi, manual
  externalId   String?    // External API identifier
  importLogId  Int?
  importLog    ImportLog? @relation(fields: [importLogId], references: [id])
  
  // Existing
  average_rating Float?    @default(0)
  review_count   Int       @default(0)
  trending_score Float?    @default(0)
  is_trending    Boolean   @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  categories   Category[]
  tags         Tag[]
  jobs         Job[]      // User roles this tool is ideal for
  tasks        Task[]     // Actions this tool can perform
  reviews      Review[]
  views        View[]
  
  // New Analytics Relations
  toolViews       ToolView[]
  externalClicks  ExternalClick[]
  trendingSnapshots TrendingTool[]
  
  // Blog relations
  blog_posts      BlogPost[]  @relation("BlogToolRelation")

  @@index([slug])
  @@index([trending_score])
  @@index([is_trending])
  @@index([featured])
  @@index([verified])
}

model Category {
  id              Int      @id @default(autoincrement())
  name            String
  slug            String   @unique
  featured        Boolean  @default(false)
  seo_title       String?
  seo_description String?
  seo_h1          String?
  seo_content     String?
  tools           Tool[]
  
  // New Analytics Relations
  categoryViews     CategoryView[]
  trendingSnapshots TrendingCategory[]

  @@index([slug])
  @@index([featured])
}

model Tag {
  id    Int    @id @default(autoincrement())
  name  String @unique
  tools Tool[]
}

// ---------------------------------------------------------------
// Multi-dimensional Categorization: Jobs and Tasks
// ---------------------------------------------------------------

model Job {
  id          Int      @id @default(autoincrement())
  name        String   @unique  // e.g., "Data Scientist", "Content Creator", "Developer"
  slug        String   @unique
  description String?
  icon        String?  // Icon name or URL
  featured    Boolean  @default(false)
  tools       Tool[]

  @@index([slug])
  @@index([featured])
}

model Task {
  id          Int      @id @default(autoincrement())
  name        String   @unique  // e.g., "Create Image", "Write Blog Posts", "Summarize Text"
  slug        String   @unique
  description String?
  icon        String?  // Icon name or URL
  featured    Boolean  @default(false)
  tools       Tool[]

  @@index([slug])
  @@index([featured])
}

model Review {
  id        Int      @id @default(autoincrement())
  rating    Int
  title     String?
  body      String?
  createdAt DateTime @default(now())

  toolId    Int
  tool      Tool     @relation(fields: [toolId], references: [id])
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
}

model Submission {
  id             Int              @id @default(autoincrement())
  submitterName  String
  submitterEmail String
  toolData       Json
  status         SubmissionStatus @default(PENDING)
  createdAt      DateTime         @default(now())

  userId         Int?
  user           User?            @relation(fields: [userId], references: [id])
  
  // New Analytics Relations
  submissionEvents SubmissionEvent[]
}

model View {
  id        Int      @id @default(autoincrement())
  ipHash    String?
  sessionId String?
  createdAt DateTime @default(now())

  toolId    Int
  tool      Tool     @relation(fields: [toolId], references: [id])
}

// ---------------------------------------------------------------
// Analytics models
// ---------------------------------------------------------------

model ToolView {
  id        Int      @id @default(autoincrement())
  toolId    Int
  createdAt DateTime @default(now())
  ipHash    String?  @db.VarChar(64)

  tool      Tool     @relation(fields: [toolId], references: [id])

  @@index([toolId, createdAt])
}

model ExternalClick {
  id        Int      @id @default(autoincrement())
  toolId    Int
  createdAt DateTime @default(now())
  source    String?  @db.VarChar(64)

  tool      Tool     @relation(fields: [toolId], references: [id])

  @@index([toolId, createdAt])
}

model CategoryView {
  id          Int      @id @default(autoincrement())
  categoryId  Int
  createdAt   DateTime @default(now())

  category    Category @relation(fields: [categoryId], references: [id])

  @@index([categoryId, createdAt])
}

model SubmissionEvent {
  id          Int      @id @default(autoincrement())
  submissionId Int
  createdAt   DateTime @default(now())

  submission  Submission @relation(fields: [submissionId], references: [id])
}

model TrendingTool {
  id          Int      @id @default(autoincrement())
  toolId      Int
  score       Float
  snapshotAt  DateTime @default(now())

  tool        Tool     @relation(fields: [toolId], references: [id])

  @@unique([toolId, snapshotAt])
}

model TrendingCategory {
  id          Int      @id @default(autoincrement())
  categoryId  Int
  score       Float
  snapshotAt  DateTime @default(now())

  category    Category @relation(fields: [categoryId], references: [id])

  @@unique([categoryId, snapshotAt])
}

// ---------------------------------------------------------------
// Auto-Import Tracking
// ---------------------------------------------------------------

model ImportLog {
  id          Int      @id @default(autoincrement())
  source      String   // huggingface, openrouter, rapidapi, all
  fetched     Int      @default(0)
  imported    Int      @default(0)
  skipped     Int      @default(0)
  errors      Json? // Array of error strings
  timestamp   DateTime @default(now())
  tools       Tool[]

  @@index([source, timestamp])
}

// ---------------------------------------------------------------
// Blog/News Section
// ---------------------------------------------------------------

model BlogPost {
  id              Int       @id @default(autoincrement())
  title           String
  slug            String    @unique
  excerpt         String?   @db.Text    // Short summary for listings
  content         String    @db.Text    // Full article content (Markdown)
  cover_image     String?               // Hero image URL
  
  // SEO Fields
  seo_title       String?
  seo_description String?   @db.Text
  
  // Metadata
  author          String?               // Author name
  published       Boolean   @default(false)
  featured        Boolean   @default(false)
  read_time       Int?                  // Estimated minutes to read
  
  // Related tools (for articles like "Top 10 alternatives to...")
  related_tools   Tool[]    @relation("BlogToolRelation")
  
  // Timestamps
  publishedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([published, publishedAt])
  @@index([featured])
}

