# Claude AI Integration Guide

## Overview

The `/api/ai/summary` endpoint uses Claude AI (Anthropic) to generate intelligent summaries of AI tools, including pros/cons analysis and target audience recommendations.

## Environment Variables

Add these to your `backend/.env` file:

```env
# Required for AI features
ANTHROPIC_API_KEY=sk-ant-api03-...

# Optional: Redis for caching (highly recommended for production)
REDIS_URL=redis://localhost:6379
# For Redis Cloud:
# REDIS_URL=redis://username:password@host:port

# Existing variables
DATABASE_URL=...
JWT_SECRET=...
```

## Features

- **Intelligent Summaries**: 100-150 word overviews generated by Claude
- **Pros & Cons**: Structured analysis of tool strengths and weaknesses
- **Target Audience**: 3-sentence description of ideal users
- **24-Hour Caching**: Redis caching reduces API costs and improves performance
- **Graceful Degradation**: Works without Redis (no caching) or without Claude (returns placeholder)

## API Endpoints

### POST /api/ai/summary

Generate an AI summary for a tool.

**Request Body:**

```json
{
  "toolId": 123
}
```

OR

```json
{
  "toolData": {
    "name": "ChatGPT",
    "description": "Advanced conversational AI",
    "features": ["Natural language", "Context awareness", "Multi-turn dialogue"]
  }
}
```

**Response:**

```json
{
  "summary": "ChatGPT is an advanced AI chatbot...",
  "pros": [
    "Highly accurate natural language understanding",
    "Excellent context retention",
    "Wide range of use cases"
  ],
  "cons": [
    "Requires internet connection",
    "May generate plausible but incorrect information",
    "Limited to text-based interactions"
  ],
  "whoFor": "ChatGPT is ideal for developers, writers, and researchers who need an AI assistant for brainstorming, coding help, or content creation. It's particularly useful for teams looking to automate customer support or generate documentation. Best suited for users comfortable with AI limitations and fact-checking."
}
```

## Claude Prompt Template

The exact prompt sent to Claude:

```
You are an AI expert reviewing software tools. Analyze the following AI tool and provide a structured summary.

Tool Name: {tool.name}
Description: {tool.description}

Key Features:
- {feature1}
- {feature2}
...

Please provide a JSON response with the following structure:
{
  "summary": "A 100-150 word overview of what this tool does and its main value proposition",
  "pros": ["pro1", "pro2", "pro3"],
  "cons": ["con1", "con2", "con3"],
  "whoFor": "A 3-sentence description of the ideal user or use case for this tool"
}

Keep your response concise, objective, and helpful. Focus on practical insights.
```

## Caching Strategy

**Cache Key Format:**
- For `toolId`: `ai:summary:tool:{toolId}`
- For `toolData`: `ai:summary:data:{base64(JSON.stringify(toolData))}`

**TTL:** 24 hours (86400 seconds)

**Benefits:**
- Reduces API costs (Claude charges per token)
- Improves response time (cached responses ~10ms vs ~2-5s for API call)
- Rate limit protection

## Security Considerations

### 1. API Key Protection
- **Never commit** `ANTHROPIC_API_KEY` to version control
- Store in environment variables only
- Use different keys for dev/staging/prod
- Rotate keys regularly (quarterly recommended)

### 2. Rate Limiting
```typescript
// Add to your Fastify app.ts
import rateLimit from '@fastify/rate-limit';

app.register(rateLimit, {
  max: 100, // 100 requests
  timeWindow: '15 minutes',
  cache: 10000,
  allowList: ['127.0.0.1'], // Whitelist localhost in dev
});
```

### 3. Request Validation
- Always validate `toolId` exists before querying
- Sanitize `toolData` input (already handled by Zod schemas)
- Limit request size (Fastify default: 1MB)

### 4. Error Handling
- Don't expose API keys in error messages
- Log errors server-side only
- Return generic errors to clients:
  ```typescript
  catch (error) {
    console.error('Claude API error:', error); // Log full error
    return reply.status(500).send({ 
      error: 'Failed to generate summary' // Generic message
    });
  }
  ```

### 5. Cost Management
- Set usage limits in Anthropic dashboard
- Monitor token usage via Anthropic console
- Consider implementing per-user quotas
- Cache aggressively (current: 24hr TTL)

### 6. Redis Security
- Use TLS for Redis connections in production
- Set strong Redis passwords
- Use Redis ACLs to limit command access
- Consider Redis Sentinel for high availability

## Cost Estimation

**Claude 3.5 Sonnet Pricing (as of 2024):**
- Input: $3 per million tokens
- Output: $15 per million tokens

**Typical Request:**
- Input: ~200 tokens (prompt + tool data)
- Output: ~300 tokens (summary + pros/cons)
- Cost per request: ~$0.0051

**With 24hr caching:**
- 1000 unique tools = $5.10
- Same tools requested 10,000 times = still $5.10
- Without caching: $51.00

## Testing

### Without Claude (Mock)
If `ANTHROPIC_API_KEY` is not set, the endpoint returns a placeholder:

```bash
curl -X POST http://localhost:3000/api/ai/summary \
  -H "Content-Type: application/json" \
  -d '{"toolData": {"name": "Test", "description": "A test tool"}}'
```

### With Claude
```bash
export ANTHROPIC_API_KEY=sk-ant-...
curl -X POST http://localhost:3000/api/ai/summary \
  -H "Content-Type: application/json" \
  -d '{"toolId": 1}'
```

## Monitoring

**Recommended metrics:**
- Request count (total, cached, uncached)
- Cache hit rate
- Average response time
- Claude API errors
- Token usage per day/month

**Example logging:**
```typescript
console.log({
  event: 'ai_summary_generated',
  toolId,
  cached: false,
  tokens: { input: 200, output: 300 },
  duration_ms: 2100
});
```

## Troubleshooting

**"Claude AI is not configured"**
- Verify `ANTHROPIC_API_KEY` is set in `.env`
- Restart the backend server after adding the key

**"Redis error"**
- Check Redis is running: `redis-cli ping`
- Verify `REDIS_URL` in `.env`
- Endpoint works without Redis (caching disabled)

**"Rate limit exceeded"**
- Check Anthropic dashboard for limits
- Implement request throttling
- Increase cache TTL to reduce API calls

## Production Checklist

- [ ] `ANTHROPIC_API_KEY` set in production environment
- [ ] Redis configured with TLS
- [ ] Rate limiting enabled
- [ ] Error monitoring (Sentry, etc.)
- [ ] Cost alerts configured in Anthropic dashboard
- [ ] Caching verified working
- [ ] Backup strategy for Redis data
- [ ] API key rotation schedule established
